<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ÙØ±Ù… Ú¯Ø²Ø§Ø±Ø´ Ø­Ø§Ø¯Ø«Ù‡ Ø­ÙØ§Ø±ÛŒ</title>

  <!-- Bootstrap RTL -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" />

  <!-- Persian Datepicker -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/css/persian-datepicker.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-date@1.1.0/dist/persian-date.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/persian-datepicker@1.2.0/dist/js/persian-datepicker.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      background-color: #f8f9fa;
      font-family: "Vazirmatn", sans-serif;
    }
    .container {
      max-width: 650px;
    }
    .card {
      border-radius: 1rem;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
    }
  </style>
</head>
<body>
  <div class="container py-5">
    <h3 class="text-center fw-bold mb-4">ÙØ±Ù… Ú¯Ø²Ø§Ø±Ø´ Ø­Ø§Ø¯Ø«Ù‡ Ø­ÙØ§Ø±ÛŒ</h3>

    <form id="incidentForm" class="card p-4">
      <div class="mb-3">
        <label class="form-label">Ø´Ù…Ø§Ø±Ù‡ Ùˆ Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¯Ú©Ù„</label>
        <input type="text" class="form-control" id="rigLocation" required />
      </div>

      <div class="mb-3">
        <label class="form-label">ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† Ø­Ø§Ø¯Ø«Ù‡</label>
        <input type="text" id="incidentDate" class="form-control" required />
      </div>

      <div class="mb-3">
        <label class="form-label">Ù†Ø§Ù… Ú¯Ø²Ø§Ø±Ø´â€ŒØ¯Ù‡Ù†Ø¯Ù‡</label>
        <input type="text" class="form-control" id="name" required />
      </div>

      <div class="mb-3">
        <label class="form-label">Ø³Ù…Øª Ø´ØºÙ„ÛŒ</label>
        <input type="text" class="form-control" id="jobPosition" required />
      </div>

      <div class="mb-3">
        <label class="form-label">Ù†ÙˆØ¹ Ø­Ø§Ø¯Ø«Ù‡</label>
        <select id="incidentType" class="form-select" required>
          <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
          <option>Ø¢Ø³ÛŒØ¨ Ø´Ø®ØµÛŒ</option>
          <option>Ù†Ø²Ø¯ÛŒÚ© Ø¨Ù‡ Ø­Ø§Ø¯Ø«Ù‡ (Near Miss)</option>
          <option>Ø¢Ø³ÛŒØ¨ ØªØ¬Ù‡ÛŒØ²</option>
          <option>Ù…Ø­ÛŒØ· Ø²ÛŒØ³ØªÛŒ</option>
          <option>Ø³Ø§ÛŒØ± Ù…ÙˆØ§Ø±Ø¯</option>
        </select>
      </div>

      <div class="mb-3">
        <label class="form-label">ØªÙˆØ¶ÛŒØ­Ø§Øª Ø§ÙˆÙ„ÛŒÙ‡</label>
        <textarea class="form-control" id="initialReport" rows="4" required></textarea>
      </div>

      <div class="mb-3">
        <label class="form-label">Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³</label>
        <input type="file" class="form-control" id="photo" accept="image/*" />
      </div>

      <button type="submit" class="btn btn-primary w-100">Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´</button>
    </form>

    <div id="message" class="mt-4 text-center fw-bold"></div>
  </div>

  <script>
    // ÙØ¹Ø§Ù„â€ŒØ³Ø§Ø²ÛŒ ØªÙ‚ÙˆÛŒÙ… Ø´Ù…Ø³ÛŒ
    $(document).ready(function() {
      $("#incidentDate").persianDatepicker({
        format: "YYYY/MM/DD HH:mm",
        timePicker: {
          enabled: true
        },
        initialValue: true,
      });
    });

    // ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Supabase
    const SUPABASE_URL = "https://YOUR_PROJECT_URL.supabase.co"; // â† Ø§ÛŒÙ†Ùˆ Ø¹ÙˆØ¶ Ú©Ù†
    const SUPABASE_KEY = "YOUR_PUBLIC_ANON_KEY"; // â† Ø§ÛŒÙ†Ùˆ Ø¹ÙˆØ¶ Ú©Ù†
    const BUCKET_NAME = "incident-photos"; // â† Ø§Ø³Ù… Ø¨Ø§Ú©Øª Ø§Ø³ØªÙˆØ±ÛŒØ¬ Ø¯Ø± Supabase
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const form = document.getElementById("incidentForm");
    const message = document.getElementById("message");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      message.textContent = "Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ú¯Ø²Ø§Ø±Ø´... Ù„Ø·ÙØ§Ù‹ ØµØ¨Ø± Ú©Ù†ÛŒØ¯ â³";

      const fileInput = document.getElementById("photo");
      let photo_url = null;

      // ğŸ“¤ Ø¢Ù¾Ù„ÙˆØ¯ ÙØ§ÛŒÙ„ Ø¨Ù‡ Supabase Storage
      if (fileInput.files.length > 0) {
        const file = fileInput.files[0];
        const fileName = `${Date.now()}_${file.name}`;
        const { error: uploadError } = await supabase.storage.from(BUCKET_NAME).upload(fileName, file);

        if (uploadError) {
          message.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¢Ù¾Ù„ÙˆØ¯ Ø¹Ú©Ø³: " + uploadError.message;
          return;
        }

        const { data: publicURLData } = supabase.storage.from(BUCKET_NAME).getPublicUrl(fileName);
        photo_url = publicURLData.publicUrl;
      }

      // ğŸ§¾ Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯Ø± Ø¬Ø¯ÙˆÙ„
      const { error: insertError } = await supabase.from("incident_reports").insert([
        {
          rig_location: document.getElementById("rigLocation").value,
          incident_datetime: document.getElementById("incidentDate").value,
          name: document.getElementById("name").value,
          job_position: document.getElementById("jobPosition").value,
          incident_type: document.getElementById("incidentType").value,
          initial_report: document.getElementById("initialReport").value,
          photo_url: photo_url,
          created_at: new Date().toISOString(),
        },
      ]);

      if (insertError) {
        message.textContent = "âŒ Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª: " + insertError.message;
      } else {
        message.textContent = "âœ… Ú¯Ø²Ø§Ø±Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø«Ø¨Øª Ø´Ø¯.";
        form.reset();
      }
    });
  </script>
</body>
</html>
